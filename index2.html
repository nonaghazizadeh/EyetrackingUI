<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Cognitive Eye-Tracking Experiment</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 2em;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: #fafafa;
      text-align: center;
    }
    #experimentContainer, #results {
      width: 80%;
      max-width: 800px;
    }
    #taskContainer {
      font-size: 24px;
      line-height: 1.8em;
      min-height: 6em;
      padding: 1em;
      border: 1px solid #ccc;
      border-radius: 8px;
      background: #fff;
      margin-bottom: 1.5em;
    }
    #taskContainer span {
      margin: 0 5px;
      padding: 2px 5px;
      border-radius: 6px;
    }
    .question {
        font-weight: bold;
        color: #333;
        display: block;
        margin-bottom: 1em;
        text-align: left;
        word-break: break-word;
    }
    .answer {
        color: #555;
        display: block;
        text-align: left;
        word-break: break-word;
    }
    #status {
      font-size: 18px;
      color: #555;
      margin-bottom: 1em;
      line-height: 1.6;
      text-align: left;
      max-width: 600px;
    }
    #startButton {
      font-size: 20px;
      padding: 10px 20px;
      cursor: pointer;
    }
    #results {
      display: none;
      text-align: left;
    }
    #downloadLink {
      display: block;
      margin: 1em 0;
      font-size: 18px;
      padding: 12px;
      background-color: #007bff;
      color: white;
      text-align: center;
      text-decoration: none;
      border-radius: 5px;
    }
    #jsonData {
      width: 100%;
      height: 300px;
      font-family: monospace;
      font-size: 14px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>

  <div id="experimentContainer">
    <div id="taskContainer"></div>
    <div id="status">
        <b>Instructions:</b> You are about to see a series of questions and answers. Each one will be displayed for about 12 seconds. Please read them to understand the logic. Feel free to look back and forth between the question and the answer as you think.
    </div>
    <button id="startButton" disabled>Calibrating... Please Follow the Dot</button>
  </div>
  
  <div id="results">
    <h2>Experiment Complete!</h2>
    <p>Thank you for your participation. Your gaze data has been compiled below.</p>
    <a href="#" id="downloadLink">Download results.json</a>
    <h3>Raw JSON Data</h3>
    <textarea id="jsonData" readonly></textarea>
  </div>

  <script src="https://webgazer.cs.brown.edu/webgazer.js"></script>
  <script>
    // --- Configuration ---
    const tasks = [
      {
        question: "A farmer has 17 sheep and all but 8 die. How many sheep are left?",
        answer: "The answer is 8. The phrase 'all but 8' directly states the number remaining."
      },
      {
        question: "What is the meaning of the sentence: The old man the boat?",
        answer: "The word 'man' is used as a verb, meaning to operate. The elderly are staffing the boat."
      },
      {
        question: "Data: Team A scored 20 points. Team B scored 40. Team C scored 30. Is the following statement true or false? Team B scored more than A and C combined.",
        answer: "False. Team A and C's combined score is 50, which is more than Team B's score of 40."
      }
    ];
    const DURATION_PER_TASK = 12000; // 12 seconds in milliseconds

    // --- UI Elements ---
    const taskContainer = document.getElementById("taskContainer");
    const statusEl = document.getElementById("status");
    const startButton = document.getElementById("startButton");
    const experimentContainer = document.getElementById("experimentContainer");
    const resultsContainer = document.getElementById("results");

    // --- State Variables ---
    let allResults = [];
    let currentTaskIndex = 0;
    let gazeCounts = [];
    let scanpath = [];
    let wordSpans = [];
    let allWords = [];
    let collecting = false;
    let currentWord = null;
    let lastWord = null;
    let dwellStart = 0;

    // --- WebGazer Initialization ---
    window.onload = async () => {
      await webgazer.setRegression("ridge")
        .setGazeListener((data, elapsed) => {
          if (!data || !collecting) return;
          const { x, y } = data;
          let hitWordIndex = null;
          wordSpans.forEach((span, i) => {
            const rect = span.getBoundingClientRect();
            if (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
              hitWordIndex = i;
              gazeCounts[i]++;
            }
          });
          if (hitWordIndex !== null) {
            if (hitWordIndex !== currentWord) {
              currentWord = hitWordIndex;
              dwellStart = elapsed;
            } else {
              if (elapsed - dwellStart > 100) {
                if (hitWordIndex !== lastWord) {
                  scanpath.push(hitWordIndex);
                  lastWord = hitWordIndex;
                }
              }
            }
          }
        })
        .begin();
      
      webgazer.showVideoPreview(false).showPredictionPoints(false);
      webgazer.clearData();

      startButton.disabled = false;
      startButton.textContent = "Start Experiment";
    };

    // --- Experiment Flow ---
    startButton.addEventListener("click", startExperiment);

    // MODIFIED TO HIDE THE STATUS ELEMENT
    function startExperiment() {
      allResults = [];
      currentTaskIndex = 0;
      startButton.style.display = "none";
      statusEl.style.display = "none"; // Hide the instructions/status text
      showNextTask();
    }

    function showNextTask() {
      if (currentTaskIndex >= tasks.length) {
        displayFinalResults();
        return;
      }
      taskContainer.innerHTML = "";
      const task = tasks[currentTaskIndex];
      const questionText = `Question: ${task.question}`;
      const answerText = `Answer: ${task.answer}`;
      allWords = `${questionText} ${answerText}`.split(/\s+/);
      gazeCounts = new Array(allWords.length).fill(0);
      scanpath = [];
      wordSpans = [];
      currentWord = null;
      lastWord = null;
      
      const qSpan = document.createElement('div');
      qSpan.className = 'question';
      questionText.split(/\s+/).forEach(word => {
          const span = document.createElement("span");
          span.textContent = word;
          qSpan.appendChild(span);
          wordSpans.push(span);
      });
      taskContainer.appendChild(qSpan);

      const aSpan = document.createElement('div');
      aSpan.className = 'answer';
      answerText.split(/\s+/).forEach(word => {
          const span = document.createElement("span");
          span.textContent = word;
          aSpan.appendChild(span);
          wordSpans.push(span);
      });
      taskContainer.appendChild(aSpan);

      collecting = true;
      setTimeout(processAndGoNext, DURATION_PER_TASK);
    }

    function processAndGoNext() {
      collecting = false;
      const regressions = [];
      for (let i = 1; i < scanpath.length; i++) {
        if (scanpath[i] < scanpath[i-1]) {
          regressions.push({
            from: allWords[scanpath[i-1]],
            to: allWords[scanpath[i]],
          });
        }
      }
      allResults.push({
        task: tasks[currentTaskIndex],
        gaze_counts_per_word: allWords.map((word, i) => ({ word, count: gazeCounts[i] })),
        scanpath_words: scanpath.map(i => allWords[i]),
        regressions: regressions
      });
      currentTaskIndex++;
      showNextTask();
    }

    function displayFinalResults() {
      webgazer.end();
      experimentContainer.style.display = "none";
      resultsContainer.style.display = "block";
      const jsonString = JSON.stringify(allResults, null, 2);
      document.getElementById("jsonData").value = jsonString;
      const blob = new Blob([jsonString], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const downloadLink = document.getElementById("downloadLink");
      downloadLink.href = url;
      downloadLink.download = "cognitive_scanpath_results.json";
    }
  </script>
</body>
</html>