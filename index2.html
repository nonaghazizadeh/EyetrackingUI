<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Enhanced Eye-Tracking Experiment</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 2em;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: #fafafa;
      text-align: center;
    }
    #experimentContainer, #results {
      width: 80%;
      max-width: 800px;
    }
    #sentence {
      font-size: 26px;
      line-height: 1.8em;
      min-height: 3em; /* Reserve space to prevent layout shifts */
      color: #333;
    }
    #sentence span {
      margin: 0 6px;
      padding: 2px 6px;
      border-radius: 6px;
    }
    #status {
      margin-top: 1em;
      font-size: 18px;
      color: #555;
    }
    #startButton {
      font-size: 20px;
      padding: 10px 20px;
      cursor: pointer;
    }
    #results {
      display: none; /* Hidden by default */
      text-align: left;
    }
    #downloadLink {
      display: block;
      margin: 1em 0;
      font-size: 18px;
      padding: 12px;
      background-color: #007bff;
      color: white;
      text-align: center;
      text-decoration: none;
      border-radius: 5px;
    }
    #jsonData {
      width: 100%;
      height: 300px;
      font-family: monospace;
      font-size: 14px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>

  <div id="experimentContainer">
    <div id="sentence"></div>
    <div id="status">Please look at the red dot to calibrate, then click Start.</div>
    <button id="startButton" disabled>Start Experiment</button>
  </div>
  
  <div id="results">
    <h2>Experiment Complete!</h2>
    <p>Your gaze data has been compiled. You can download it as a JSON file.</p>
    <a href="#" id="downloadLink">Download scanpath_results.json</a>
    <h3>Raw JSON Data</h3>
    <textarea id="jsonData" readonly></textarea>
  </div>

  <script src="https://webgazer.cs.brown.edu/webgazer.js"></script>
  <script>
    // --- Configuration ---
    const sentences = [
      "The quick brown fox jumps over the lazy dog.",
      "Eye-tracking technology helps us understand user behavior on web pages.",
      "Regressions are when the eye moves backward to re-read previous text.",
      "This is the final sentence of the experiment."
    ];
    const DURATION_PER_SENTENCE = 10000; // 10 seconds in milliseconds

    // --- UI Elements ---
    const sentenceContainer = document.getElementById("sentence");
    const statusEl = document.getElementById("status");
    const startButton = document.getElementById("startButton");
    const experimentContainer = document.getElementById("experimentContainer");
    const resultsContainer = document.getElementById("results");

    // --- State Variables ---
    let allResults = [];
    let currentSentenceIndex = 0;
    let gazeCounts = [];
    let scanpath = [];
    let wordSpans = [];
    let words = [];
    
    let collecting = false;
    let currentWord = null;
    let lastWord = null;
    let dwellStart = 0;

    // --- WebGazer Initialization ---
    window.onload = async () => {
      await webgazer.setRegression("ridge")
        .setGazeListener((data, elapsed) => {
          if (!data || !collecting) return;

          const x = data.x;
          const y = data.y;
          let hitWordIndex = null;

          wordSpans.forEach((span, i) => {
            const rect = span.getBoundingClientRect();
            if (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
              hitWordIndex = i;
              gazeCounts[i]++;
            }
          });

          // Update scanpath with dwell filter (~100ms)
          if (hitWordIndex !== null) {
            if (hitWordIndex !== currentWord) {
              currentWord = hitWordIndex;
              dwellStart = elapsed;
            } else {
              if (elapsed - dwellStart > 100) { // Fixated for >100ms
                if (hitWordIndex !== lastWord) {
                  scanpath.push(hitWordIndex);
                  lastWord = hitWordIndex;
                }
              }
            }
          }
        })
        .begin();
      
      webgazer.showVideoPreview(true).showPredictionPoints(true);
      
      // Enable start button once WebGazer is ready
      startButton.disabled = false;
      statusEl.textContent = "Calibration complete. You can now start the experiment.";
    };

    // --- Experiment Flow ---
    startButton.addEventListener("click", startExperiment);

    function startExperiment() {
      allResults = [];
      currentSentenceIndex = 0;
      startButton.style.display = "none";
      statusEl.textContent = "The experiment is in progress...";
      showNextSentence();
    }

    function showNextSentence() {
      if (currentSentenceIndex >= sentences.length) {
        displayFinalResults();
        return;
      }

      // Clear previous sentence
      sentenceContainer.innerHTML = "";
      
      // Reset state for the new sentence
      const sentenceText = sentences[currentSentenceIndex];
      words = sentenceText.split(" ");
      gazeCounts = new Array(words.length).fill(0);
      scanpath = [];
      wordSpans = [];
      currentWord = null;
      lastWord = null;
      dwellStart = 0;

      // Create and display the new sentence
      words.forEach(w => {
        const span = document.createElement("span");
        span.textContent = w;
        sentenceContainer.appendChild(span);
        wordSpans.push(span);
      });

      // Start collecting data and set timer for the next step
      collecting = true;
      setTimeout(processAndGoNext, DURATION_PER_SENTENCE);
    }

    function processAndGoNext() {
      collecting = false; // Stop data collection

      // Calculate regressions for the completed sentence
      const regressions = [];
      for (let i = 1; i < scanpath.length; i++) {
        if (scanpath[i] < scanpath[i-1]) {
          regressions.push({
            from: words[scanpath[i-1]],
            to: words[scanpath[i]],
            from_index: scanpath[i-1],
            to_index: scanpath[i]
          });
        }
      }

      // Store the results for this sentence
      allResults.push({
        sentence: sentences[currentSentenceIndex],
        words: words,
        gaze_counts: gazeCounts,
        scanpath_indices: scanpath,
        scanpath_words: scanpath.map(i => words[i]),
        regressions: regressions
      });

      // Move to the next sentence
      currentSentenceIndex++;
      showNextSentence();
    }

    function displayFinalResults() {
      webgazer.end();
      experimentContainer.style.display = "none";
      resultsContainer.style.display = "block";

      const jsonString = JSON.stringify(allResults, null, 2); // Pretty print JSON

      // Display in textarea
      document.getElementById("jsonData").value = jsonString;

      // Create download link
      const blob = new Blob([jsonString], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const downloadLink = document.getElementById("downloadLink");
      downloadLink.href = url;
      downloadLink.download = "scanpath_results.json";
    }
  </script>
</body>
</html>